#!/bin/bash
#
# polyrepl - load a SML program defined in a MLB file into the Poly/ML
# interactive environment
#
# Chris Cannam, 2015-2018. MIT licence

set -e

debug=no
if [ "$1" = "-d" ]; then
    debug=yes
    shift
fi

arg="$1"

if [ -z "$arg" ]; then
    echo "Usage: $0 [-d] file.sml" 1>&2
    echo "       $0 [-d] file.mlb" 1>&2
    echo "where" 1>&2
    echo "  -d: Enable Poly/ML compiler debug mode before reading SML source" 1>&2
    exit 1
fi

shift
set -u

mydir=$(dirname "$0")
. "$mydir/smlbuild-include.sh"

out=$(get_outfile "$arg")  # we don't use this, but it does some arg error checking

if [ "$debug" = "yes" ]; then
    rlwrap poly --eval 'PolyML.Compiler.debug := true;' $(expand_arg "$arg" | sed 's/^\(.*\)$/--use \1/') --eval '"Entering trace mode; evaluate `PolyML.Debug.trace false` to leave";' --eval 'PolyML.Debug.trace true;'
else
    rlwrap poly $(expand_arg "$arg" | sed 's/^\(.*\)$/--use \1/')
fi


